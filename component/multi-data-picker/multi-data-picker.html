<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Multi_data_picker</title>
    <link rel="stylesheet" href="multi-data-picker.css">
    <script src="base-data.js" charset="utf-8"></script>
</head>
<body>
    <input type="text" id="selector" value="北京" readonly>
    <input type="hidden" id="hidden_selector" value="1001">
    <span>设置可选城市上限：</span><input type="text" class="set_limit_num">
    <p class="tips">注：下次设置请重新刷新页面，设置完成点击城市名称</p>
    <script type="text/javascript">
        function Multi_data_picker(a,e,d,b,c){this._level_one_to_selectedNum={};this._level_one_id_to_dom={};this._selected_dom_obj={};this.trigger_selector=a;this.hidden_selector=e;this.separator=d;this.selector_value=document.getElementById(a).value.split(this.separator)||[];this.hidden_value=document.getElementById(e).value.split(this.separator)||[];this.init_data=b||[];this.select_num_limit=c||Number.MAX_SAFE_INTEGER;this._data_level_one=(function(){if(b.length===0){return[]}else{return b.map(function(g,f){return g.id})}})();if(document.querySelectorAll(".multi-picker").length===0){this.init(this.selector_value,this.hidden_value)}else{this.show()}}Multi_data_picker.prototype={constructor:Multi_data_picker,init:function(b,c){var a='<section class="multi-picker">                                  <section class="multi-label">                                    <section class="picker-selected">                                        <label class="label-for">已选中城市：</label>                                        <section class="selected"></section>                                        <span class="submit">确定</span>                                    </section>                                  </section>                                  <section class="picker-container">                                      <ul class="data-level-one"></ul>                                      <ul class="data-level-two"></ul>                                  </section>                              </section>';this._append("body",a,false);this._init_domTree(b,c);this._bindEvent()},_init_domTree:function(a,b){a.length===0?"":this._init_selected_tree(a,b);b.length===0?"":this._init_level_one_data(a,b)},_init_selected_tree:function(b,c){var a="";b.forEach(function(e,d){a+='<span class="selected-item" data-id="'+this[d]+'">'+e+"</span>"},c);this._append(".selected",a,true)},_init_level_one_data:function(b,d){var e=this;var c=document.querySelector(".data-level-one");var a="";d.forEach(function(h,f){var g=h.slice(0,4);if(g in e._level_one_to_selectedNum){e._level_one_to_selectedNum[g]++}else{e._level_one_to_selectedNum[g]=1}});this.init_data.forEach(function(g,f){if(g.id in e._level_one_to_selectedNum){a+='<li class="level-one" data-id="'+g.id+'">'+g.name+"<span>"+e._level_one_to_selectedNum[g.id]+"</span></li>"}else{a+='<li class="level-one" data-id="'+g.id+'">'+g.name+"<span></span></li>"}});this._append(".data-level-one",a,true);document.querySelector(".level-one").classList.add("checked");[].forEach.call(document.querySelectorAll(".level-one"),function(g,f){e._level_one_id_to_dom[g.getAttribute("data-id")]=g});c.querySelector(".level-one").getAttribute("data-id") in this._level_one_to_selectedNum?this._init_level_two_data(0,[c.querySelector(".level-one").getAttribute("data-id")]):this._init_level_two_data()},_init_level_two_data:function(c,a){c=c||0;a=a||[];var b="";if(a.length===0){this.init_data[c].items.forEach(function(e,d){b+='<li class="level-two" data-id="'+e.id+'">'+e.name+"</li>"})}else{if(a.indexOf(this._data_level_one[c]+"")!==-1){this.init_data[c].items.forEach(function(e,d){if(d===0){b+='<li class="level-two checked" data-id="'+e.id+'">'+e.name+"</li>"}else{b+='<li class="level-two disabled" data-id="'+e.id+'">'+e.name+"</li>"}})}else{this.init_data[c].items.forEach(function(e,d){if(a.indexOf(e.id+"")!==-1){b+='<li class="level-two checked" data-id="'+e.id+'">'+e.name+"</li>"}else{b+='<li class="level-two" data-id="'+e.id+'">'+e.name+"</li>"}})}}this._append(".data-level-two",b,true)},_bindEvent:function(){var b=this;var a=this._data_level_one[0];document.body.addEventListener("click",function(h){var f=h.target.getAttribute("data-id");if(h.target.classList.contains("level-one")){if(f===a){return}else{b._level_one_id_to_dom[a].classList.remove("checked");h.target.classList.add("checked");a=f;var e=h.target.querySelector("span").textContent===""?false:true;var g=b._data_level_one.indexOf(parseInt(f));if(e){var d=b._get_selected_data().selected_id.filter(function(j,i){return j.slice(0,4)===f});b._init_level_two_data(g,d)}else{b._init_level_two_data(g)}}}else{if(h.target.classList.contains("disabled")){return}else{if(h.target.classList.contains("level-two")){var c=h.target.textContent;if(h.target.classList.contains("checked")){b._rerender_selected_data("delete",f);if(f.length===4){b._level_two_toggleClass("unlock")}h.target.className="level-two"}else{if(b._rerender_selected_data("add",f,c)===false){return false}if(f.length===4){b._level_two_toggleClass("lock")}h.target.className="level-two checked"}}else{if(h.target.classList.contains("selected-item")){b._rerender_selected_data("delete",f);if(f.slice(0,4)===a){[].forEach.call(document.querySelectorAll(".level-two"),function(j,i){if(j.getAttribute("data-id")===f){j.className="level-two"}});if(f.length===4){b._level_two_toggleClass("unlock")}}}else{if(h.target.classList.contains("submit")){b._set_submit_data(b._get_selected_data().selected_id,b._get_selected_data().selected_name);b.hide()}}}}}})},_level_two_toggleClass:function(a){switch(a){case"lock":[].forEach.call(document.querySelectorAll(".level-two"),function(c,b){if(b!==0){c.className="level-two disabled"}});break;case"unlock":[].forEach.call(document.querySelectorAll(".level-two"),function(c,b){if(b!==0){c.className="level-two"}});break;default:break}},_rerender_selected_data:function(d,c,a){var e=this;switch(d){case"delete":this._delete_selected_element(c,"delete");if(c.length===4){e._update_level_one_num("all",c,"delete")}else{e._update_level_one_num("one",c.slice(0,4),"delete")}break;case"add":if(c.length===4){this._get_selected_data().selected_id.filter(function(g,f){return g.slice(0,4)===c&&g.length===7}).forEach(function(g,f){e._delete_selected_element(g);e._update_level_one_num("one",g,"delete")})}if(e._get_selected_data().selected_id.length==e.select_num_limit){alert("选择以达到最大值："+e.select_num_limit);return false}this._add_selected_element(c,a);var b=c.length===4?"all":"one";this._update_level_one_num(b,c,"add");break;default:break}},_add_selected_element:function(b,a){var c=document.createElement("span");c.className="selected-item";c.setAttribute("data-id",b);c.textContent=a;document.querySelector(".selected").appendChild(c)},_delete_selected_element:function(a){var c=this;var b=this._get_selected_dom();document.querySelector(".selected").removeChild(b[a])},_update_level_one_num:function(b,a,c){switch(b){case"all":if(c==="add"){this._level_one_id_to_dom[a].querySelector("span").textContent=1;this._level_one_to_selectedNum[a]=1}else{this._level_one_id_to_dom[a].querySelector("span").textContent="";this._level_one_to_selectedNum[a]=0}break;case"one":if(c==="add"){if(!(a.slice(0,4) in this._level_one_to_selectedNum)){this._level_one_to_selectedNum[a.slice(0,4)]=0}this._level_one_id_to_dom[a.slice(0,4)].querySelector("span").textContent=this._level_one_to_selectedNum[a.slice(0,4)]+1;this._level_one_to_selectedNum[a.slice(0,4)]++}else{this._level_one_id_to_dom[a.slice(0,4)].querySelector("span").textContent=this._level_one_to_selectedNum[a.slice(0,4)]-1||"";this._level_one_to_selectedNum[a.slice(0,4)]--}break;default:break}},_get_selected_data:function(){var b=[];var a=[];[].forEach.call(document.querySelectorAll(".selected-item"),function(d,c){b.push(d.getAttribute("data-id"));a.push(d.textContent)});return{selected_id:b,selected_name:a}},_get_selected_dom:function(){var a=this;[].forEach.call(document.querySelectorAll(".selected-item"),function(c,b){a._selected_dom_obj[c.getAttribute("data-id")]=c});return a._selected_dom_obj},_set_submit_data:function(a,b){document.getElementById(this.hidden_selector).value=a.join(this.separator);document.getElementById(this.trigger_selector).value=b.join(this.separator)},show:function(){document.querySelector(".multi-picker").style.display="block"},hide:function(){document.querySelector(".multi-picker").style.display="none"},destory:function(){document.body.removeChild(document.querySelector(".multi-picker"))},_append:function(c,b,a){if(a===true){document.querySelector(c).innerHTML=b}else{document.querySelector(c).innerHTML+=b}}};document.addEventListener("click",function(b){if(b.target.id=="selector"){var a=document.querySelector(".set_limit_num").value||3;new Multi_data_picker("selector","hidden_selector",",",city,a)}},false);
    </script>
</body>
</html>
