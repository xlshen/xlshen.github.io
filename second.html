<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            border: 0;
            outline: 0;
        }
        li{
            list-style-type: none;
        }
        html,body{
            height: 100%;
            font: 14px/20px "Microsoft YaHei";
            box-sizing: border-box;
        }
        .multi-picker{
            height: 100vh;
            display: flex;
            flex-flow: column;
        }
        .picker-selected{
            flex: 0 0 30px;
            display: flex;
        }
        .label-for{
            flex: 0 0 8em;
        }
        .selected .selected-item{
            padding: 0 4px;
        }
        .picker-container{
            flex: 0 1 auto;
            display: flex;
        }
        .data-level{
            flex: 1;
            display: flex;
        }
        .picker-container .data-level-one{
            flex: 1;
            overflow-y: scroll;
        }
        .picker-container .data-level-two{
            flex: 2;
            overflow-y: scroll;
        }
        .level-one{
            line-height: 2;
        }
        .level-two{
            line-height: 2;
        }
        .level-one span{
            color: #f90
        }
        .level-two.checked{
            color: #f90
        }
        .level-two.disabled{
            color: #ddd;
        }
    </style>
</head>
<body>

    <section class="multi-picker">
        <section class="picker-selected">
            <label class="label-for">已选中的城市：</label>
            <section class="selected"></section>
        </section>
        <section class="picker-container">
            <section class="data-level">
                <ul class="data-level-one"></ul>
                <ul class="data-level-two"></ul>
            </section>
        </section>
    </section>
    <script type="text/javascript">
    var city = [
        { "id": 1001, "name": "北京", "items": [{ "id": 1001, "name": "北京" }] },
        { "id": 1002, "name": "天津", "items": [{ "id": 1002, "name": "天津" }] },
        { "id": 1003, "name": "上海", "items": [{ "id": 1003, "name": "上海" }] },
        { "id": 1004, "name": "重庆", "items": [{ "id": 1004, "name": "重庆" }] },
        { "id": 2001, "name": "河北", "items": [{ "id": 2001, "name": "河北" }, { "id": 2001001, "name": "石家庄" }, { "id": 2001002, "name": "唐山" }, { "id": 2001003, "name": "秦皇岛" }, { "id": 2001004, "name": "邯郸" }, { "id": 2001005, "name": "邢台" }, { "id": 2001006, "name": "保定" }, { "id": 2001007, "name": "张家口" }, { "id": 2001008, "name": "承德" }, { "id": 2001009, "name": "沧州" }, { "id": 2001010, "name": "廊坊" }, { "id": 2001011, "name": "衡水" }] },
        { "id": 2002, "name": "山西", "items": [{ "id": 2002, "name": "山西" }, { "id": 2002001, "name": "太原" }, { "id": 2002002, "name": "大同" }, { "id": 2002003, "name": "阳泉" }, { "id": 2002004, "name": "长治" }, { "id": 2002005, "name": "晋城" }, { "id": 2002006, "name": "朔州" }, { "id": 2002007, "name": "晋中" }, { "id": 2002008, "name": "运城" }, { "id": 2002009, "name": "忻州" }, { "id": 2002010, "name": "临汾" }, { "id": 2002011, "name": "吕梁" }, { "id": 2002012, "name": "永济市" }] },
        { "id": 2003, "name": "内蒙古", "items": [{ "id": 2003, "name": "内蒙古" }, { "id": 2003001, "name": "呼和浩特" }, { "id": 2003002, "name": "包头" }, { "id": 2003003, "name": "乌海" }, { "id": 2003004, "name": "赤峰" }, { "id": 2003005, "name": "通辽" }, { "id": 2003006, "name": "鄂尔多斯" }, { "id": 2003007, "name": "呼伦贝尔" }, { "id": 2003008, "name": "兴安盟" }, { "id": 2003009, "name": "锡林郭勒盟" }, { "id": 2003010, "name": "乌兰察布" }, { "id": 2003011, "name": "巴彦淖尔" }, { "id": 2003012, "name": "阿拉善盟" }] },
        { "id": 2004, "name": "辽宁", "items": [{ "id": 2004, "name": "辽宁" }, { "id": 2004001, "name": "沈阳" }, { "id": 2004002, "name": "大连" }, { "id": 2004003, "name": "鞍山" }, { "id": 2004004, "name": "抚顺" }, { "id": 2004005, "name": "本溪" }, { "id": 2004006, "name": "丹东" }, { "id": 2004007, "name": "锦州" }, { "id": 2004008, "name": "营口" }, { "id": 2004009, "name": "阜新" }, { "id": 2004010, "name": "辽阳" }, { "id": 2004011, "name": "盘锦" }, { "id": 2004012, "name": "铁岭" }, { "id": 2004013, "name": "朝阳" }, { "id": 2004014, "name": "葫芦岛" }] },
        { "id": 2005, "name": "吉林", "items": [{ "id": 2005, "name": "吉林" }, { "id": 2005001, "name": "长春" }, { "id": 2005002, "name": "吉林" }, { "id": 2005003, "name": "四平" }, { "id": 2005004, "name": "辽源" }, { "id": 2005005, "name": "通化" }, { "id": 2005006, "name": "白山" }, { "id": 2005007, "name": "松原" }, { "id": 2005008, "name": "白城" }, { "id": 2005009, "name": "延吉" }, { "id": 2005010, "name": "延边朝鲜族自治区" }] },
        { "id": 2006, "name": "黑龙江", "items": [{ "id": 2006, "name": "黑龙江" }, { "id": 2006001, "name": "哈尔滨" }, { "id": 2006002, "name": "齐齐哈尔" }, { "id": 2006003, "name": "鸡西" }, { "id": 2006004, "name": "鹤岗" }, { "id": 2006005, "name": "双鸭山" }, { "id": 2006006, "name": "大庆" }, { "id": 2006007, "name": "伊春" }, { "id": 2006008, "name": "佳木斯" }, { "id": 2006009, "name": "七台河" }, { "id": 2006010, "name": "牡丹江" }, { "id": 2006011, "name": "黑河" }, { "id": 2006012, "name": "绥化" }, { "id": 2006013, "name": "大兴安岭地区" }] }];
        /**
         * [City_multi_picker description]
         * @param       {[DOM元素]} element  [组件触发元素]
         * @param       {[Array]} selector_array [默认字面显示内容组成的数组]，如["北京", "上海", "天津"]
         * @param       {[Array]} hidden_value    [隐藏域ID数组]如["1001", "2001", "3001"]
         * @constructor
         */
        function City_multi_picker(element, selector_array, hidden_value, data){
            // 存储一级数据id对应的二级选中数字，建立快速索引机制{1001: 1, 2001:2, 3001:1}
            this._level_one_to_selectedNum = {};
            // 存储一级数据id对应一级数据dom元素
            this._level_one_Id_to_dom = {};
            // 存储选中元素id对应的dom数据索引
            this._selected_dom_obj = {}; // 通过_get_selected_dom()方法获取

            this.element = element;
            this.selector_array = selector_array || [];
            this.hidden_value = hidden_value || [];
            this.init_data = data || []; // 全局输入数据
            this._data_level_one = (function(){
                if(data.length === 0){
                    return [];
                }else{
                    return data.map(function(value, index){
                        return value.id;
                    });
                }
            })(); // 一级数据列表，方便查找使用

            // 初始化组件
            this.init(this.element, this.selector_array, this.hidden_value, this._data_level_one);
        }
        City_multi_picker.prototype = {
            constructor: City_multi_picker,
            /**
             * [description] 
             * @param  {[DOM]} selector [description]
             */
            init: function(element, selector_array, hidden_value, data){
                // DOM加载
                // document.body.innerHTML = this._init_domTree();
                this._init_domTree(selector_array, hidden_value); // 暂时执行_init_selected_tree
                this._bindEvent();
            },
            /**
             * [description]
             * @param  {[Array]} data [城市数组]
             * @return {[DOM]}      [返回DOM-Tree]
             */
            _init_domTree: function(selector_array, hidden_value, data){
                // this.level_one_dom_tree 一级数据dom数组
                // this._init_selected_tree
                this._init_selected_tree(selector_array, hidden_value);
                hidden_value.length === 0 ? "" : this._init_level_one_data(selector_array, hidden_value);
                // this.level_one_dom_tree = this._init_level_one_tree(data);
                return ;
            },
            _init_selected_tree:function(selector_array, hidden_value){
                var selected_template =  "";
                selector_array.map(function(value, index){
                    selected_template += '<span class="selected-item" data-id="'+ this[index] +'">'+ value +'</span>';
                }, hidden_value);
                // return selected_template;
                document.querySelector(".selected").innerHTML = selected_template;
            },
            /**
             * [一级数据构建]
             * @param  {[Array]} selector_array
             * @param  {[Array]} hidden_value
             */
            _init_level_one_data: function(selector_array, hidden_value){
                var _this = this;
                var FIRST_LEVEL_ONE_ELEMENT = document.querySelector(".data-level-one");
                var level_one_template = "";
                /**
                 * [初始化一级数据]
                 */
                hidden_value.forEach(function(value, index){
                    var sliceFour = value.slice(0, 4); // 取前四位数字
                    if(sliceFour in _this._level_one_to_selectedNum){
                        _this._level_one_to_selectedNum[sliceFour] ++;
                    }else{
                        _this._level_one_to_selectedNum[sliceFour] = 1;
                    }
                });
                /**
                 * [构建一级数据dom tree]
                 */
                this.init_data.forEach(function(value, index){
                    if(value.id in _this._level_one_to_selectedNum){
                        level_one_template += '<li class="level-one" data-id="'+ value.id +'">'+ value.name +'<span>'+ _this._level_one_to_selectedNum[value.id] +'</span></li>';
                    }else{
                        level_one_template += '<li class="level-one" data-id="'+ value.id +'">'+ value.name +'<span></span></li>';
                    }
                });
                document.querySelector(".data-level-one").innerHTML = level_one_template;
                /**
                 * 在此把_level_one_Id_to_dom初始化
                 */
                [].forEach.call(document.querySelectorAll(".level-one"), function(value, index){
                    _this._level_one_Id_to_dom[value.getAttribute("data-id")] = value;
                });
                // 第一个元素是否在里面
                if(hidden_value.indexOf(FIRST_LEVEL_ONE_ELEMENT.querySelector(".level-one").getAttribute("data-id")) !== -1){
                    this._init_level_two_data(0, [FIRST_LEVEL_ONE_ELEMENT.querySelector(".level-one").getAttribute("data-id")]);
                }
            },
            /**
             * [初始化二级数据]
             * @param  {[Number]} _level_two_init_data_index [一级数据的索引值]
             * @param  {[Array]} checked_item_array [选中二级数据数组，默认为空]
             */
            _init_level_two_data: function(_level_two_init_data_index, checked_item_array){
                var level_two_template = ""; // 二级数据缩影数组
                // 如果没有选中值直接初始化数据，否则遍历二级数据初始化
                if(checked_item_array.length === 0){
                    this.init_data[_level_two_init_data_index].items.forEach(function(value, index){
                        level_two_template += '<li class="level-two" data-id="'+ value.id +'">'+ value.name +'</li>';
                    });
                }else{
                    this.init_data[_level_two_init_data_index].items.forEach(function(value, index){
                        if(checked_item_array.indexOf(value.id + "") !== -1){
                            level_two_template += '<li class="level-two checked" data-id="'+ value.id +'">'+ value.name +'</li>'
                        }else{
                            level_two_template += '<li class="level-two" data-id="'+ value.id +'">'+ value.name +'</li>';
                        }
                    })
                }
                // dom添加
                document.querySelector(".data-level-two").innerHTML = level_two_template;
            },
            /**
             * [获取已经选中数据]
             */
            _get_selected_data: function(){
                return [].map.call(document.querySelectorAll(".selected-item"), function(value, index){
                            return value.getAttribute("data-id");
                        });
            },
            _get_selected_dom: function(){
                var _this = this;
                [].forEach.call(document.querySelectorAll(".selected-item"), function(value, index){
                    _this._selected_dom_obj[value.getAttribute("data-id")] = value;
                });
                return _this._selected_dom_obj;
            },
            /**
             * [动态更新选中数据]
             * @param  {[Number]} type   [更新数据方式，0是删除，1是增加]
             * @param  {[Number]} dataId   [二级数据id]
             * @param  {[String]} dataName [二级数据文字描述]
             */
            _rerender_selected_data: function(type, dataId, dataName){
                var _this = this;
                switch (type) {
                    case 0:
                        // 删除选中数据
                        this._delete_selected_element(dataId, "delete");
                        break;
                    case 1:
                        // 更新二级选中数据disabled
                        if(dataId.length === 4){
                            // 判断删除操作
                            this._get_selected_data().filter(function(value, index){
                                return value.slice(0, 4) === dataId && value.length === 7;
                            }).forEach(function(value, index){
                                _this._delete_selected_element(value, "delete");
                            });
                        }
                        // 增加选中数据
                        var updateType = dataId.length === 4 ? 0 : 1;
                        this._add_selected_element(updateType, dataId, dataName);
                        break;
                    default: break;
                }
            },
            /**
             * [更新一级数据选中数字]
             * @param  {[Number]} type [如果是一级全部数据为0, 普通二级数据为1]
             * @param  {[DOM]} type [删除的二级数据对应的一级数据的dom元素]
             */
            _update_level_one_num: function(type, elementid_to_level_one_dom, add_or_delete){
                switch (type) {
                    case 0:
                        if(add_or_delete === "add"){
                            this._level_one_Id_to_dom[elementid_to_level_one_dom].querySelector("span").textContent = 1;
                            // 更新_level_one_to_selectedNum
                            this._level_one_to_selectedNum[elementid_to_level_one_dom] = 1;
                        }else{
                            this._level_one_Id_to_dom[elementid_to_level_one_dom].querySelector("span").textContent = "";
                            // 更新_level_one_to_selectedNum
                            this._level_one_to_selectedNum[elementid_to_level_one_dom] = 0;
                        }
                        break;
                    case 1:
                        if(!(elementid_to_level_one_dom.slice(0, 4) in this._level_one_to_selectedNum)){
                            this._level_one_to_selectedNum[elementid_to_level_one_dom.slice(0, 4)] = 0;
                        }
                        if(add_or_delete === "add"){
                            this._level_one_Id_to_dom[elementid_to_level_one_dom.slice(0, 4)].querySelector("span").textContent =  this._level_one_to_selectedNum[elementid_to_level_one_dom.slice(0, 4)] + 1;
                            // 更新_level_one_to_selectedNum
                            this._level_one_to_selectedNum[elementid_to_level_one_dom.slice(0, 4)] ++;
                        }else{
                            this._level_one_Id_to_dom[elementid_to_level_one_dom.slice(0, 4)].querySelector("span").textContent =  this._level_one_to_selectedNum[elementid_to_level_one_dom.slice(0, 4)] - 1;
                            // 更新_level_one_to_selectedNum
                            this._level_one_to_selectedNum[elementid_to_level_one_dom.slice(0, 4)] --;
                        }
                        break;
                    default: break;
                }
            },

            /**
             * [通过传入dataId判断是否是全选数据，控制lock和unlock状态]
             * @param  {[String]} type     [类型"lock"二级数据可点击 || "unlock"二级数据不可点击]
             * @param  {[String]} dataId   [description]
             * @param  {[String]} dataName [description]
             */
            _level_two_toggleClass: function(type, dataId, dataName){
                switch (type) {
                    case "lock":
                        [].forEach.call(document.querySelectorAll(".level-two"), function(value, index){
                            // 排除第一个
                            if(index !== 0){
                                value.className = "level-two disabled";
                            }
                        });
                        break;
                    case "unlock":
                        [].forEach.call(document.querySelectorAll(".level-two"), function(value, index){
                            // 排除第一个
                            if(index !== 0){
                                value.className = "level-two";
                            }
                        });
                        break;
                    default: break;
                }
            },
            /**
             * [添加选中元素dom]
             */
            _add_selected_element: function(updateType, dataId, dataName){
                var element = document.createElement("span");
                element.className = "selected-item";
                element.setAttribute("data-id", dataId);
                element.textContent = dataName;

                document.querySelector(".selected").appendChild(element);

                this._update_level_one_num(updateType, dataId, "add");
            },
            /**
             * [删除选中元素]
             * @param  {[dom]} target [description]
             */
            _delete_selected_element: function(dataId, update_type){
                var _this = this;
                var selectedDOM = this._get_selected_dom();
                var delete_element;

                // delete_element = this._get_selected_data().filter(function(value, index){
                //     return value === dataId;
                // });

                // delete_element.forEach(function(value, index){
                    // if(dataId in selectedDOM){
                        document.querySelector(".selected").removeChild(selectedDOM[dataId]);
                        if(dataId.length === 4){
                            // 更新左侧一级数据选中数字
                            _this._update_level_one_num(0, dataId, update_type);
                        }else{
                            // 更新左侧一级数据选中数字
                            _this._update_level_one_num(1, dataId.slice(0, 4), update_type);
                        }
                    // }
                // })
            },
            _bindEvent: function(){
                var _this = this;
                var current_index_id; // 当前一级数据当前索引，通过该索引提前判断以及数据是否被激活
                document.body.addEventListener("click", function (event) {
                    // 设置一级数据点击事件，通过是否active判断当前是否激活，如果激活再次点击无效
                    if(event.target.classList.contains("level-one")){
                        var dataId = event.target.getAttribute("data-id");
                        if(dataId === current_index_id){
                            return ;
                        }else{
                            current_index_id = dataId;
                            /**
                             * @param  {[level_two_isCheck]}  一级数据有标识二级数据有选中的元素，通过一级数据后面的数字判断
                             * true 有二级数据 || false 没有二级数据
                             */
                            var level_two_isCheck = event.target.querySelector("span").textContent === "" ? false: true;
                            // 通过_data_level_one查找data中对应的二级数据，初始化二级数据
                            var _level_two_init_data_index = _this._data_level_one.indexOf(parseInt(dataId)); // 点击一级数据索引
                            if(level_two_isCheck){
                                // 获取一级数据对应的选中二级数据
                                var checked_item_array = _this._get_selected_data().filter(function(value, index){
                                    return value.slice(0, 4) === dataId;
                                });
                                // 初始化二级数据
                                _this._init_level_two_data(_level_two_init_data_index, checked_item_array);
                            }else{
                                _this._init_level_two_data(_level_two_init_data_index, []);
                            }

                        }
                        // 获取选中数据
                    }else if(event.target.classList.contains("disabled")){
                        return ;
                    }else if(event.target.classList.contains("level-two")){
                        var dataId = event.target.getAttribute("data-id");
                        var dataName = event.target.textContent;
                        // 判断当前元素是否选中
                        if(event.target.classList.contains("checked")){
                            event.target.className = "level-two";
                            if(dataId.length === 4){
                                _this._level_two_toggleClass("unlock", dataId, dataName);
                            }
                            // 删除选中城市
                            _this._rerender_selected_data(0, dataId, dataName);
                        }else{
                            event.target.className = "level-two checked";
                            if(dataId.length === 4){
                                _this._level_two_toggleClass("lock", dataId, dataName);
                            }
                            // 添加选中城市
                            _this._rerender_selected_data(1, dataId, dataName);
                        }
                    }
                });
            },
            show: function(){

            },
            hide: function(){

            },
            destory: function(){

            }
        }
        new City_multi_picker("", ["北京", "石家庄", "秦皇岛", "重庆"], ["1001", "2001001", "2001003", "1004"], city);
    </script>
</body>
</html>
